<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dr. GPT Financial Consultant - Quackosaurus-rex</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Pixelify Sans', sans-serif;
      height: 100vh;
      overflow: hidden;
      background: linear-gradient(rgba(0,0,0,0.35), rgba(0,0,0,0.35)), url('./assets/backgrounds/LivingRoom.jpeg') center/cover no-repeat;
    }
    
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100%;
      background: transparent;
    }
    
    /* Header */
    .chat-header {
      padding: 20px;
      background: rgba(0,0,0,0.7);
      border-bottom: 3px solid #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
    }
    
    .chat-header h1 {
      color: #fff;
      font-size: 2rem;
      font-weight: 700;
    }
    
    .menu-button {
      background: transparent;
      background-image: url('./assets/buttons/buttonMedium.PNG');
      background-size: 100% 100%;
      background-repeat: no-repeat;
      background-position: center;
      border: none;
      color: #000;
      padding: 12px 20px;
      font-family: 'Pixelify Sans', sans-serif;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, filter 0.2s ease;
    }
    
    .menu-button:hover {
      transform: scale(1.05);
      filter: brightness(1.1);
    }
    
    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 10px;
      background: rgba(0,0,0,0.9);
      border: 2px solid #fff;
      border-radius: 8px;
      min-width: 220px;
      overflow: hidden;
      z-index: 1000;
    }
    
    .dropdown-content.show {
      display: block;
    }
    
    .dropdown-item {
      display: block;
      padding: 15px 20px;
      color: #fff;
      text-decoration: none;
      cursor: pointer;
      font-family: 'Pixelify Sans', sans-serif;
      font-size: 18px;
      font-weight: 500;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      transition: background 0.2s;
    }
    
    .dropdown-item:last-child {
      border-bottom: none;
    }
    
    .dropdown-item:hover {
      background: rgba(255,255,255,0.1);
    }
    
    /* Chat messages area */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      scroll-behavior: smooth;
    }
    
    .chat-messages::-webkit-scrollbar {
      width: 8px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.2);
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.3);
      border-radius: 4px;
    }
    
    /* Message bubble */
    .message {
      display: flex;
      max-width: 70%;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    
    .message.ai {
      align-self: flex-start;
    }
    
    .message-bubble {
      padding: 15px 20px;
      font-size: 20px;
      line-height: 1.5;
      color: #fff;
      word-wrap: break-word;
      min-height: 50px;
      display: flex;
      align-items: center;
      border-radius: 20px;
      position: relative;
      animation: bubbleIn 0.4s ease-out;
    }
    
    @keyframes bubbleIn {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .message.user .message-bubble {
      background: rgba(255, 255, 255, 0.85);
      border: 2px solid rgba(255, 255, 255, 0.95);
      color: #000;
    }
    
    .message.ai .message-bubble {
      background: rgba(52, 152, 152, 0.9); /* Jade blue - more opaque */
      border: 2px solid rgba(52, 152, 152, 1);
      box-shadow: 0 4px 15px rgba(52, 152, 152, 0.5);
      color: #fff;
    }
    
    .message.ai .message-bubble::before {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      border-radius: 20px;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.2) 0%, transparent 50%);
      pointer-events: none;
      animation: shimmer 2s ease-in-out infinite;
    }
    
    @keyframes shimmer {
      0%, 100% {
        opacity: 0.3;
      }
      50% {
        opacity: 0.6;
      }
    }
    
    /* Input area */
    .chat-input-area {
      padding: 20px;
      background: rgba(0,0,0,0.95);
      border-top: 3px solid #fff;
      display: flex;
      gap: 10px;
      z-index: 100;
    }
    
    .chat-input-area input {
      flex: 1;
      padding: 15px 20px;
      font-size: 20px;
      font-family: 'Pixelify Sans', sans-serif;
      border: 3px solid #fff;
      border-radius: 10px;
      background: rgba(255,255,255,0.95);
      color: #000;
    }
    
    .chat-input-area input:focus {
      outline: none;
      background: #fff;
    }
    
    .chat-input-area input::placeholder {
      color: #666;
      font-family: 'Pixelify Sans', sans-serif;
    }
    
    .send-button {
      padding: 15px 30px;
      font-size: 20px;
      font-weight: 700;
      font-family: 'Pixelify Sans', sans-serif;
      background: transparent;
      background-image: url('./assets/buttons/buttonMedium.PNG');
      background-size: 100% 100%;
      background-repeat: no-repeat;
      background-position: center;
      color: #000;
      border: none;
      border-radius: 0;
      cursor: pointer;
      transition: transform 0.2s ease, filter 0.2s ease;
      min-width: 120px;
    }
    
    .send-button:hover:not(:disabled) {
      transform: scale(1.05);
      filter: brightness(1.1);
    }
    
    .send-button:active:not(:disabled) {
      transform: scale(0.98);
      filter: brightness(0.95);
    }
    
    .send-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .loading {
      display: inline-block;
      margin-left: 10px;
    }
    
    .loading span {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666;
      margin: 0 2px;
      animation: bounce 1.4s infinite ease-in-out both;
    }
    
    .loading span:nth-child(1) { animation-delay: -0.32s; }
    .loading span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <!-- Header with Menu -->
    <div class="chat-header">
      <h1>Dr. GPT Financial Consultant</h1>
      <div style="position: relative;">
        <button class="menu-button" id="menuButton">☰ Menu</button>
        <div class="dropdown-content" id="dropdownContent">
          <div class="dropdown-item" data-action="go-back">Go Back to Options</div>
          <div class="dropdown-item" data-action="mute">🔊 Mute Music</div>
        </div>
      </div>
    </div>
    
    <!-- Chat Messages Area -->
    <div class="chat-messages" id="chatMessages">
      <!-- Initial greeting message -->
      <div class="message ai">
        <div class="message-bubble">
          Hi! I'm Dr. GPT, your AI Financial Consultant! 🤖<br>
          Ask me anything about finances!
        </div>
      </div>
    </div>
    
    <!-- Input Area -->
    <div class="chat-input-area">
      <input type="text" id="userMessageInput" placeholder="Ask me anything about finances..." />
      <button class="send-button" id="sendMessageBtn">Send</button>
    </div>
  </div>

  <script>
    // Animalese audio for character speech
    let currentAnimaleseAudio = null;
    let animaleseInstance = null;
    
    async function loadAnimalese() {
      // Check if already initialized
      if (animaleseInstance) {
        return animaleseInstance;
      }
      
      // Load required dependencies
      return new Promise((resolve, reject) => {
        // Load riffwave.js first (required dependency)
        if (!window.RIFFWAVE) {
          console.log('Loading riffwave.js...');
          const riffwaveScript = document.createElement('script');
          riffwaveScript.src = 'https://acedio.github.io/animalese.js/riffwave.js';
          riffwaveScript.onload = () => {
            console.log('riffwave.js loaded');
            loadAnimaleseScript();
          };
          riffwaveScript.onerror = () => reject(new Error('Failed to load riffwave.js'));
          document.head.appendChild(riffwaveScript);
        } else {
          loadAnimaleseScript();
        }
        
        function loadAnimaleseScript() {
          // Load animalese.js
          if (!window.Animalese) {
            console.log('Loading animalese.js...');
            const script = document.createElement('script');
            script.src = 'https://acedio.github.io/animalese.js/animalese.js';
            script.onload = () => {
              // Initialize Animalese with the audio file
              if (window.Animalese) {
                console.log('Initializing Animalese with audio file...');
                const audioFileUrl = 'https://acedio.github.io/animalese.js/animalese.wav';
                animaleseInstance = new window.Animalese(audioFileUrl, () => {
                  console.log('✅ Animalese initialized successfully!');
                  resolve(animaleseInstance);
                });
              } else {
                reject(new Error('Animalese constructor not found'));
              }
            };
            script.onerror = (err) => {
              console.error('Failed to load animalese.js script:', err);
              reject(new Error('Failed to load animalese.js'));
            };
            document.head.appendChild(script);
          } else {
            // Already loaded, just initialize
            console.log('Animalese already in window, initializing...');
            const audioFileUrl = 'https://acedio.github.io/animalese.js/animalese.wav';
            animaleseInstance = new window.Animalese(audioFileUrl, () => {
              console.log('✅ Animalese initialized successfully!');
              resolve(animaleseInstance);
            });
          }
        }
      });
    }
    
    async function playAnimalese(text = '') {
      console.log('playAnimalese called with text:', text);
      
      // Check if muted
      if (window.animaleseMuted) {
        console.log('Animalese is muted');
        return;
      }
      
      if (!text || text.trim() === '') {
        console.log('No text provided');
        return;
      }
      
      try {
        // Stop any currently playing audio
        if (currentAnimaleseAudio) {
          if (!currentAnimaleseAudio.paused) {
            currentAnimaleseAudio.pause();
          }
          currentAnimaleseAudio.currentTime = 0;
        }
        
        // Load animalese if needed
        console.log('Loading animalese...');
        const animalese = await loadAnimalese();
        console.log('Animalese loaded:', animalese);
        
        // Generate and play animalese audio
        // animalese.Animalese(text, shorten, pitch) returns a WAV data URI
        if (animalese && animalese.Animalese) {
          try {
            console.log('Generating animalese audio for text:', text.substring(0, 50) + '...');
            
            // Generate WAV: Animalese(text, shorten=false, pitch=1.0)
            const pitch = 1.0; // Default pitch
            const wavObject = animalese.Animalese(text, false, pitch);
            console.log('WAV object generated:', wavObject);
            
            // The method returns a RIFFWAVE object, we need the dataURI property
            let wavDataUri;
            if (typeof wavObject === 'string') {
              // If it's already a string, use it directly
              wavDataUri = wavObject;
            } else if (wavObject && wavObject.dataURI) {
              // If it's a RIFFWAVE object, extract the dataURI
              wavDataUri = wavObject.dataURI;
              console.log('Extracted dataURI from RIFFWAVE object');
            } else {
              console.error('❌ Animalese returned unexpected format:', wavObject);
              return;
            }
            
            // Create Audio object from the WAV data URI
            const audio = new Audio();
            audio.src = wavDataUri;
            audio.volume = 0.7;
            
            currentAnimaleseAudio = audio;
            
            // Try to play - handle autoplay restrictions
            try {
              console.log('Attempting to play audio...');
              const playPromise = currentAnimaleseAudio.play();
              if (playPromise !== undefined) {
                await playPromise;
                console.log('✅ Animalese playing successfully!');
              }
            } catch (playError) {
              console.warn('⚠️ Autoplay blocked - user interaction required:', playError);
            }
          } catch (err) {
            console.error('❌ Error generating animalese audio:', err);
            console.error('Error stack:', err.stack);
          }
        } else {
          console.error('❌ Animalese instance or Animalese method not found');
          console.log('Animalese instance:', animalese);
        }
      } catch (error) {
        console.error('❌ Animalese audio error:', error);
        console.error('Error stack:', error.stack);
      }
    }
    
    // Button sound effects
    let audioContext = null;
    
    function initAudioContext() {
      if (!audioContext) {
        try {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
          return null;
        }
      }
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
      return audioContext;
    }
    
    function playButtonHoverSound() {
      // Check if muted
      if (window.animaleseMuted) {
        return;
      }
      
      try {
        const ctx = initAudioContext();
        if (!ctx) return;
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        oscillator.frequency.value = 600;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.1);
      } catch (e) {}
    }
    
    function playButtonClickSound() {
      // Check if muted
      if (window.animaleseMuted) {
        return;
      }
      
      try {
        const ctx = initAudioContext();
        if (!ctx) return;
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        oscillator.frequency.value = 400;
        oscillator.type = 'square';
        gainNode.gain.setValueAtTime(0.15, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.15);
      } catch (e) {}
    }
    
    // Menu functionality
    const menuButton = document.getElementById('menuButton');
    const dropdownContent = document.getElementById('dropdownContent');
    
    menuButton.addEventListener('mouseenter', playButtonHoverSound);
    menuButton.addEventListener('click', (e) => {
      playButtonClickSound();
      e.stopPropagation();
      dropdownContent.classList.toggle('show');
    });
    
    document.addEventListener('click', (e) => {
      if (!menuButton.contains(e.target) && !dropdownContent.contains(e.target)) {
        dropdownContent.classList.remove('show');
      }
    });
    
    dropdownContent.querySelectorAll('.dropdown-item').forEach(item => {
      item.addEventListener('click', (e) => {
        const action = item.getAttribute('data-action');
        dropdownContent.classList.remove('show');
        
        // Don't play sound if we're muting (would be ironic!)
        if (action !== 'mute') {
          playButtonClickSound();
        }
        
        if (action === 'go-back') {
          window.location.href = 'bankReception.html';
        } else if (action === 'mute') {
          // Toggle mute for ALL audio (animalese, button sounds)
          window.animaleseMuted = !window.animaleseMuted;
          
          // Stop all currently playing animalese audio
          if (currentAnimaleseAudio && !currentAnimaleseAudio.paused) {
            currentAnimaleseAudio.pause();
            currentAnimaleseAudio.currentTime = 0;
          }
          
          // Update button text and add visual indicator
          if (window.animaleseMuted) {
            item.textContent = '🔇 Unmute Music';
            item.style.opacity = '0.7';
            item.style.fontWeight = '700';
          } else {
            item.textContent = '🔊 Mute Music';
            item.style.opacity = '1';
            item.style.fontWeight = '600';
          }
        }
      });
    });
    
    // Chat functionality
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('userMessageInput');
    const sendBtn = document.getElementById('sendMessageBtn');
    
    function addMessage(text, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.textContent = text;
      
      messageDiv.appendChild(bubble);
      chatMessages.appendChild(messageDiv);
      
      // Scroll to bottom
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      return messageDiv;
    }
    
    function showLoading() {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message ai';
      messageDiv.id = 'loadingMessage';
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.innerHTML = 'Thinking<span class="loading"><span></span><span></span><span></span></span>';
      
      messageDiv.appendChild(bubble);
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function removeLoading() {
      const loadingMsg = document.getElementById('loadingMessage');
      if (loadingMsg) {
        loadingMsg.remove();
      }
    }
    
    async function sendChatMessage() {
      const message = chatInput.value.trim();
      if (!message) return;
      
      // Add user message
      addMessage(message, true);
      chatInput.value = '';
      
      // Disable input
      chatInput.disabled = true;
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';
      
      // Show loading
      showLoading();
      
      try {
        // Use relative path for production (Netlify), fallback to localhost for local dev
        const apiUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
          ? 'http://127.0.0.1:5000/chat'
          : '/chat';
        
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message: message })
        });
        
        const data = await response.json();
        
        // Remove loading
        removeLoading();
        
        if (data.error) {
          addMessage(`Sorry, I encountered an error: ${data.error}`);
        } else {
          // Add AI response with typing effect
          const reply = data.reply;
          const aiMessageDiv = document.createElement('div');
          aiMessageDiv.className = 'message ai';
          
          const bubble = document.createElement('div');
          bubble.className = 'message-bubble';
          aiMessageDiv.appendChild(bubble);
          chatMessages.appendChild(aiMessageDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
          
          // Start playing animalese audio for the full text
          playAnimalese(reply);
          
          // Type out the response
          for (let i = 0; i < reply.length; i++) {
            bubble.textContent = reply.substring(0, i + 1);
            await new Promise(r => setTimeout(r, 20));
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        }
      } catch (error) {
        console.error('Error:', error);
        removeLoading();
        addMessage('Sorry, I couldn\'t connect to the server. Make sure Flask is running on http://127.0.0.1:5000');
      } finally {
        chatInput.disabled = false;
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
        chatInput.focus();
      }
    }
    
    // Event listeners
    sendBtn.addEventListener('mouseenter', playButtonHoverSound);
    sendBtn.addEventListener('click', () => {
      playButtonClickSound();
      // Unlock audio context on user interaction
      initAudioContext();
      sendChatMessage();
    });
    
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        playButtonClickSound();
        // Unlock audio context on user interaction
        initAudioContext();
        sendChatMessage();
      }
    });
    
    // Focus input on load
    chatInput.focus();
    
    // Initialize mute state
    window.animaleseMuted = false;
    
    // Audio context unlock - required for autoplay
    let audioUnlocked = false;
    function unlockAudio() {
      if (!audioUnlocked) {
        audioUnlocked = true;
        initAudioContext();
        // Try to play greeting after unlocking
        setTimeout(() => {
          playAnimalese("Hi! I'm Dr. GPT, your AI Financial Consultant! Ask me anything about finances!");
        }, 300);
      }
    }
    
    // Unlock audio on any user interaction
    document.addEventListener('click', unlockAudio, { once: true });
    document.addEventListener('keypress', unlockAudio, { once: true });
    chatInput.addEventListener('focus', unlockAudio, { once: true });
    
    // Debug: Test animalese after a delay
    setTimeout(async () => {
      console.log('=== ANIMALESE DEBUG TEST ===');
      console.log('window.animalese:', window.animalese);
      console.log('window.Animalese:', window.Animalese);
      console.log('typeof window.animalese:', typeof window.animalese);
      
      if (window.animalese) {
        console.log('Testing animalese function...');
        try {
          const testAudio = window.animalese('test');
          console.log('Test audio created:', testAudio);
          console.log('Test audio type:', testAudio?.constructor?.name);
        } catch (e) {
          console.error('Test failed:', e);
        }
      }
    }, 2000);
  </script>
</body>
</html>
