<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bank Reception - Quackosaurus-rex</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="components/chat/chat-component.css" />
  <style>
    .service-options {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      flex-direction: column;
      gap: 1.5rem;
      z-index: 1000;
      animation: fadeInScale 0.5s ease-out;
    }
    .service-options.show {
      display: flex;
    }
    @keyframes fadeInScale {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
    .service-btn {
      padding: 3.5rem 4rem;
      font-size: 1.3rem;
      font-weight: 700;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      box-shadow: none;
      transition: all 0.3s ease;
      color: #000;
      text-align: center;
      background: transparent;
      background-size: 100% 100%;
      background-repeat: no-repeat;
      background-position: center;
      min-width: 600px;
      min-height: 220px;
      font-family: 'Pixelify Sans', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .service-btn:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: none;
    }
    .service-btn:active {
      transform: translateY(-2px) scale(1.02);
    }
    .service-btn.savings {
      background-image: url('./assets/bubbles/bubbleYellow.png');
    }
    .service-btn.credit {
      background-image: url('./assets/bubbles/bubblePink.png');
    }
    .service-btn.consultant {
      background-image: url('./assets/bubbles/bubbleBlue.PNG');
    }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      z-index: 999;
    }
    .overlay.show {
      display: block;
    }
  </style>
</head>
<body>
  <div id="bank-reception-container" style="height:100vh"></div>

  <!-- Service Options Overlay -->
  <div class="overlay" id="overlay"></div>
  <div class="service-options" id="serviceOptions">
    <button class="service-btn savings" onclick="window.location.href='savings&budget.html'">
      Savings & Budgeting Room<br>
      <small style="font-size: 0.9rem; opacity: 0.9;">Learn to save like a pro and budget like a boss!</small>
    </button>
    <button class="service-btn credit" onclick="window.location.href='credit&debt.html'">
      Credit & Debt Room<br>
      <small style="font-size: 0.9rem; opacity: 0.9;">Master credit scores and crush that debt!</small>
    </button>
    <button class="service-btn consultant" onclick="window.location.href='chat.html'">
      Dr. Ka-ching<br>
      <small style="font-size: 0.9rem; opacity: 0.9;">Get personalized advice from our AI financial expert!</small>
    </button>
  </div>

  <script type="module">
    import { mountChat } from './components/chat/chat-component.js';

    // Bank Reception Dialogue
    const BANK_RECEPTION_DIALOG = [
      {
        id: 0,
        speaker: 'robot', // Using 'robot' for dino (left side)
        text: 'Looks like someone is in big trouble!!! Hmmmm... I see you are close to broke... What about visiting our bank and getting some help?'
      },
      {
        id: 1,
        speaker: 'robot',
        text: 'So, what do you say?',
        choices: [
          {
            id: 'yes',
            text: 'YES PLEASE HELP!!!',
            next: 2,
            feedback: "Fantastic enthusiasm! I love that energy! Let's get you on the right financial track!"
          },
          {
            id: 'no',
            text: 'Nah, unless you can give me some monners',
            next: 3,
            feedback: "Ha! I like your style, kid! But here's the thing - we don't give out free money... we TEACH you how to make it work for you! That's way better than free monners, trust me! ðŸ¦–ðŸ’¸"
          }
        ]
      },
      {
        id: 2,
        speaker: 'robot',
        text: "Fantastic enthusiasm! I love that energy! Let's get you on the right financial track!"
      },
      {
        id: 3,
        speaker: 'robot',
        text: "Ha! I like your style, kid! But here's the thing - we don't give out free money... we TEACH you how to make it work for you! That's way better than free monners, trust me!"
      },
      {
        id: 4,
        speaker: 'robot',
        text: "Alright, let's get you sorted! We have three amazing services that will turn your financial life around. Choose one that interests you most:"
      }
    ];

    function showServiceOptions() {
      document.getElementById('overlay').classList.add('show');
      document.getElementById('serviceOptions').classList.add('show');
    }

    function hideServiceOptions() {
      document.getElementById('overlay').classList.remove('show');
      document.getElementById('serviceOptions').classList.remove('show');
    }

    // Override the chat component to handle service selection
    const chat = mountChat('#bank-reception-container', {
      dialog: BANK_RECEPTION_DIALOG,
      assetsPath: './assets',
      speakerNames: {
        robot: 'Dino Receptionist',
        duck: 'You'
      }
    });

    // Modify the background to use bank.jpeg
    const container = document.querySelector('#bank-reception-container');
    if (container) {
      const bg = container.querySelector('.background');
      if (bg) {
        bg.style.background = 'linear-gradient(rgba(0,0,0,0.35), rgba(0,0,0,0.35)), url("./assets/backgrounds/bank.jpeg") center/cover no-repeat';
      }
      // Update avatar for dino
      const leftAvatar = container.querySelector('.avatar.left');
      if (leftAvatar) {
        leftAvatar.style.backgroundImage = 'url("./assets/characters/dino.GIF")';
      }
      // Update avatar for duck
      const rightAvatar = container.querySelector('.avatar.right');
      if (rightAvatar) {
        rightAvatar.style.backgroundImage = 'url("./assets/characters/duckFlip.GIF")';
      }
    }

    // Show service options AFTER step 4 (final dialogue) completes typing
    let servicesShown = false;
    
    // Hook into the chat component to know when step 4 finishes
    const checkAndShowServices = () => {
      if (servicesShown) return false;
      
      const lineText = container.querySelector('.line-text');
      if (!lineText) return false;
      
      const text = lineText.textContent || '';
      
      // Check if step 4 text is displayed (this is the final step with service options message)
      if (text.includes("three amazing services") && 
          text.includes("Choose one that interests you most")) {
        
        // Check if text is complete (not typing) by comparing length
        // Step 4 text is: "Alright, let's get you sorted! We have three amazing services that will turn your financial life around. Choose one that interests you most:"
        const expectedText = "Alright, let's get you sorted! We have three amazing services that will turn your financial life around. Choose one that interests you most:";
        
        // If text matches or is close to complete, and we haven't shown yet
        if (text.trim().length >= expectedText.length * 0.9) {
          // Wait a moment for user to see the message, then show options
          if (!servicesShown) {
            setTimeout(() => {
              if (!servicesShown) {
                showServiceOptions();
                servicesShown = true;
              }
            }, 1500);
            return true;
          }
        }
      }
      return false;
    };
    
    // Start monitoring immediately
    // Watch text changes in the line-text element
    const lineTextEl = container.querySelector('.line-text');
    if (lineTextEl) {
      let lastText = '';
      const textObserver = new MutationObserver(() => {
        const currentText = lineTextEl.textContent || '';
        // Only check when text actually changes
        if (currentText !== lastText) {
          lastText = currentText;
          checkAndShowServices();
        }
      });
      
      textObserver.observe(lineTextEl, { 
        childList: true, 
        characterData: true, 
        subtree: true 
      });
      
      // Also check periodically as backup
      const checkInterval = setInterval(() => {
        if (checkAndShowServices() || servicesShown) {
          clearInterval(checkInterval);
          textObserver.disconnect();
        }
      }, 500);
      
      // Fallback: Force show after 10 seconds if step 4 text is present
      setTimeout(() => {
        clearInterval(checkInterval);
        if (!servicesShown && checkAndShowServices()) {
          // Already handled
        }
      }, 10000);
    }

    // Close overlay when clicking outside (but not on the buttons)
    document.getElementById('overlay').addEventListener('click', (e) => {
      if (e.target.id === 'overlay') {
        hideServiceOptions();
      }
    });
  </script>
</body>
</html>
